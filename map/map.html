<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

        <title>Events | Restore the Fourth</title>

        <style>
            #body {
                width: 80%;
                margin: 0 auto;
            }

            #search {
                margin-bottom: 10px;
                padding: 10px;
                border: solid 1px #ccc;
            }

            #search input[type="text"] {
                box-sizing: border-box;
                display: block;
                width: 100%;
                margin-bottom: 10px;
                font-size: 18px;
            }

            #search a {
                text-decoration: none;
            }

            #search a img {
                vertical-align: middle;
            }

            #map {
                height: 600px;
            }

            #infoWindowTemplate {
                display: none;
            }

            #map .infoWindow {
                padding: 10px 0;
            }

            #map img.logo {
                width: 100px;
                padding-right: 20px;
                vertical-align: text-top;
            }
        </style>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script src="//maps.googleapis.com/maps/api/js?v=3.exp&amp;sensor=false"></script>

        <script>
            // hardcoded list of locations
            var locations = [
                {address: 'Bronx, NY', info: 'In the Bronx, let\'s do this.'},
                {address: 'Cleveland, OH', info: 'Cleveland\'s got it going on this July 4<sup>th</sup>!'},
                {address: 'Dallas, TX', info: 'Dallas wants to see Big Brother go bye-bye.'},
                {address: 'Las Vegas, NV', info: 'The people of Vegas are tired of gambling away their privacy.'}
            ];

            // map class
            function EventsMap () {
                var $mapElem = $('#map');

                // create map, center it on the US
                var map = new google.maps.Map($mapElem[0], {
                    zoom:       4,
                    center:     new google.maps.LatLng(37, -98),
                    mapTypeId:  google.maps.MapTypeId.ROADMAP
                });

                // geocoder for address <=> coords conversions
                var geocoder = new google.maps.Geocoder();

                // create single info window
                var infoWindow = new google.maps.InfoWindow({
                    content: ''
                });

                // info window template for marker popups
                var infoWindowTemplate = $('#infoWindowTemplate').html();

                // center map on user's current location
                this.centerOnGeolocation = function (callback) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                            map.panTo(pos);
                            map.setZoom(7);

                            // fill search box with named location
                            geocoder.geocode({latLng: pos}, function(results, status) {
                                if (status == google.maps.GeocoderStatus.OK) {
                                    // multiple zoom locations returned, filter out names which are too specific
                                    var goodLocations = $.grep(results, function (result) {
                                        return $.inArray('political', result.types) > -1;
                                    });

                                    var address = goodLocations.length > 0 ? goodLocations[0].formatted_address : (
                                        results.length > 0 ? results[0].formatted_address : ''
                                    );

                                    $('#search input[type="text"]').val(address);
                                }
                            });
                        }, function () {}, {timeout: 5000});
                    }
                };

                // center map on given address
                this.centerOnAddress = function (address) {
                    // get lat/long of the address
                    geocoder.geocode({address: address}, function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            console.log(results);
                            map.panTo(results[0].geometry.location);
                            map.setZoom(8);

                            $('#search input[type="text"]').val(results[0].formatted_address);
                        }
                    });
                };

                // plot new markers on the map, make them interactive
                this.plotMarkers = function (locations) {
                    var instance = this;

                    $.each(locations, function (i, location) {
                        // get address coords
                        geocoder.geocode({address: location.address}, function(results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                // plot the marker
                                var marker = new google.maps.Marker({
                                    map:        map,
                                    position:   results[0].geometry.location,
                                    title:      location.address
                                });

                                // event for opening info window
                                google.maps.event.addListener(marker, 'click', function () {
                                    var content = infoWindowTemplate
                                        .replace('{location}', location.address)
                                        .replace('{info}', location.info);

                                    infoWindow.setContent(content);
                                    infoWindow.open(map, marker);
                                });
                            }
                        });
                    });
                }
            };

            // initialize
            $(function () {
                var map = new EventsMap();

                map.plotMarkers(locations);

                $('#search').on('submit', function (e) {
                    e.preventDefault();
                    map.centerOnAddress($(this).find('input[type="text"]').val());
                });

                $('#search a').on('click', function (e) {
                    e.preventDefault();
                    map.centerOnGeolocation(function (location) {
                        $('#search input[type="text"]').val(position);
                    });
                });
            });
        </script>
    </head>
    <body><div id="body">
        <form id="search">
            <input type="text">
            <a href="#"><img src="geolocate.png" alt="Current Location"> Current Location</a>
        </form>

        <div id="map"></div>

        <div id="infoWindowTemplate">
            <div class="infoWindow">
                <div style="float: left;">
                    <img class="logo" src="http://rt4.s3.amazonaws.com/img/large_logo.png" alt="Restore the Fourth">
                </div>
                <div style="float: left; max-width: 200px;">
                    <strong>{location}</strong><br><br>
                    {info}
                </div>
            </div>
        </div>
    </div></body>
</html>
